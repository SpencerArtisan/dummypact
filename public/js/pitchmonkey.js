// Generated by CoffeeScript 1.3.3
(function() {
  var form_as_json, page_has_form, send_to_server, show_modal, submit_json;

  show_modal = function(selector, submit_event, endpoint) {
    var submit_js;
    if (endpoint == null) {
      endpoint = $("form").attr("action");
    }
    submit_js = "return submit_json({'contact':$('#contact').val(), 'name': '" + submit_event + "'}, '" + endpoint + "')";
    $(selector + ' #submit_event').attr('onclick', submit_js);
    $(selector).modal();
    return false;
  };

  submit_json = function(extra_data, endpoint) {
    var json_string;
    if (endpoint == null) {
      endpoint = $("form").attr("action");
    }
    if (page_has_form() && !$("form").validate().form()) {
      return;
    }
    json_string = form_as_json(extra_data);
    send_to_server(json_string, endpoint);
    return false;
  };

  page_has_form = function() {
    return $("form").length > 0;
  };

  form_as_json = function(extra_data) {
    var child_json, child_key, embedded_json_array, input, inputs, json, json_string, key, parent_key, val, _i, _len, _ref;
    inputs = [];
    if (page_has_form) {
      inputs = $("form").serializeArray();
    }
    for (key in extra_data) {
      val = extra_data[key];
      inputs.push({
        name: key,
        value: val
      });
    }
    json = {};
    for (_i = 0, _len = inputs.length; _i < _len; _i++) {
      input = inputs[_i];
      if (input.value !== "") {
        if (input.name.indexOf(".") === -1) {
          json[input.name] = input.value;
        } else {
          parent_key = input.name.substring(0, input.name.indexOf("."));
          child_key = input.name.substring(input.name.indexOf(".") + 1);
          embedded_json_array = (_ref = json[parent_key]) != null ? _ref : [];
          child_json = {};
          child_json[child_key] = input.value;
          embedded_json_array.push(child_json);
          json[parent_key] = embedded_json_array;
        }
      }
    }
    json_string = JSON.stringify(json);
    console.log("Form data as json is: " + json_string);
    return _.escape(json_string);
  };

  send_to_server = function(json_string, endpoint) {
    var json_form;
    json_form = $("<form id='json_form' action='" + endpoint + "' method='POST'><input type='hidden' name='json' value='" + json_string + "'/></form>");
    $("body").append(json_form);
    return json_form.submit();
  };

  window.submit_json = submit_json;

  window.show_modal = show_modal;

}).call(this);
